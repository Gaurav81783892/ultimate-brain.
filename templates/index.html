<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- MARKDOWN SUPPORT -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { background-color: #000; color: #fff; font-family: sans-serif; }
        .chat-scroll { height: calc(100vh - 140px); overflow-y: auto; padding-bottom: 20px; }
        
        /* Messages */
        .msg-user { background: #2f2f2f; color: white; padding: 10px 15px; border-radius: 18px 18px 4px 18px; max-width: 85%; margin-left: auto; margin-bottom: 10px; font-size: 15px; }
        .msg-bot { background: #000; color: #d1d5db; padding: 0 10px; max-width: 95%; margin-bottom: 20px; font-size: 15px; line-height: 1.6; }
        
        /* Image Preview (Upload hone se pehle) */
        .preview-container { position: fixed; bottom: 80px; left: 20px; background: #222; padding: 5px; border-radius: 10px; display: none; border: 1px solid #444; }
        .preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .close-preview { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* Input Area */
        .input-dock { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; padding: 12px; border-top: 1px solid #222; }
        .input-bar { background: #1a1a1a; border: 1px solid #333; border-radius: 24px; padding: 6px 12px; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-white/10 bg-black sticky top-0 z-20">
        <h1 class="text-lg font-bold tracking-widest text-cyan-400">NETRA AI</h1>
        <span class="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded">ONLINE</span>
    </div>

    <!-- Chat Area -->
    <div id="chatbox" class="chat-scroll p-4">
        <div class="msg-bot">
            <p>Namaste! Main dekh bhi sakta hu.</p>
            <p class="text-xs text-gray-500 mt-1">Photo upload karo aur pucho "Ye kya hai?"</p>
        </div>
    </div>

    <!-- Image Preview Area -->
    <div id="previewBox" class="preview-container">
        <img id="imgPreview" class="preview-img">
        <div class="close-preview" onclick="clearImage()">âœ•</div>
    </div>

    <!-- Input Dock -->
    <div class="input-dock">
        <div class="input-bar">
            
            <!-- 1. IMAGE UPLOAD BUTTON -->
            <label class="text-gray-400 hover:text-white cursor-pointer p-2">
                <i class="fa fa-paperclip text-xl"></i>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
            </label>

            <!-- 2. MIC BUTTON -->
            <button onclick="startListening()" class="text-gray-400 hover:text-white p-2">
                <i class="fa fa-microphone text-lg"></i>
            </button>
            
            <!-- 3. TEXT INPUT -->
            <input type="text" id="inp" class="flex-1 bg-transparent border-none outline-none text-white text-sm" placeholder="Message...">
            
            <!-- 4. SEND BUTTON -->
            <button onclick="send()" class="bg-white text-black w-8 h-8 rounded-full flex items-center justify-center font-bold">
                <i class="fa fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <script>
        let selectedImageBase64 = null;

        // --- FILE HANDLING ---
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImageBase64 = e.target.result; // Base64 string
                    document.getElementById('imgPreview').src = selectedImageBase64;
                    document.getElementById('previewBox').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            selectedImageBase64 = null;
            document.getElementById('fileInput').value = "";
            document.getElementById('previewBox').style.display = 'none';
        }

        // --- SEND MESSAGE ---
        async function send() {
            let inp = document.getElementById('inp');
            let txt = inp.value.trim();
            
            // Agar na text hai na image, to return
            if(!txt && !selectedImageBase64) return;

            let box = document.getElementById('chatbox');
            
            // Show User Message
            let userHtml = txt;
            if(selectedImageBase64) {
                userHtml = `<img src="${selectedImageBase64}" class="w-32 rounded-lg border border-gray-600 mb-2"><br>${txt}`;
            }
            box.innerHTML += `<div class="msg-user">${userHtml}</div>`;
            
            // Clear inputs
            inp.value = "";
            let imgToSend = selectedImageBase64; // Store temp to send
            clearImage(); 
            box.scrollTop = box.scrollHeight;

            // Loading
            let loadId = "load-" + Date.now();
            box.innerHTML += `<div id="${loadId}" class="msg-bot text-gray-500 text-sm"><i class="fa fa-circle-notch fa-spin"></i> Analyzing...</div>`;
            box.scrollTop = box.scrollHeight;

            try {
                let res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: txt, image: imgToSend })
                });
                let data = await res.json();
                
                document.getElementById(loadId).remove();

                // Show Reply (Markdown Parsed)
                let contentHtml = "";
                if(data.type === "image") {
                    contentHtml = `<p>${data.text}</p><img src="${data.content}" class="rounded-lg mt-2 w-full border border-gray-700">`;
                } else {
                    contentHtml = marked.parse(data.content);
                }

                // Clean text for speech
                let speakText = data.content.replace(/[#*`_]/g, '').replace(/<[^>]*>?/gm, '');

                box.innerHTML += `
                    <div class="msg-bot">
                        <div class="prose text-gray-300 text-sm">${contentHtml}</div>
                        <div class="mt-2 flex gap-3">
                            <button onclick="speakNow('${speakText.replace(/'/g, "\\'")}')" class="text-xs text-cyan-400 border border-cyan-900 px-2 py-1 rounded flex items-center gap-1">
                                <i class="fa fa-volume-up"></i> Listen
                            </button>
                        </div>
                    </div>`;

            } catch(e) {
                document.getElementById(loadId).innerHTML = "<span class='text-red-500'>Error connecting.</span>";
            }
            box.scrollTop = box.scrollHeight;
        }

        // --- INSTANT SPEECH ---
        function speakNow(text) {
            window.speechSynthesis.cancel();
            let utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'hi-IN'; 
            window.speechSynthesis.speak(utterance);
        }

        // --- SPEECH TO TEXT ---
        function startListening() {
            let rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            rec.lang = 'hi-IN';
            let inp = document.getElementById('inp');
            inp.placeholder = "Listening...";
            rec.onresult = function(e) {
                inp.value = e.results[0][0].transcript;
                inp.placeholder = "Message...";
                if(!selectedImageBase64) send(); // Agar image nahi hai to turant bhej do
            };
            rec.start();
        }
    </script>
</body>
        </html>
